name: stow emoji data

on:
  workflow_dispatch:
  schedule:
    # Run daily at 15:20 UTC
    - cron: "20 15 * * *"

permissions: {}

jobs:
  stow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: process emoji data
        env:
          API_KEY: ${{ secrets.MOJI_STOW_API_KEY }}
          API_BASE_URL: "https://mojistow.mojis.dev/hashes"
        run: |
          # find all versions
          VERSIONS=$(ls data)
          echo "discovered versions: $VERSIONS"

          for version in $VERSIONS; do
            echo "processing version: $version"

            # generate hash for current version
            HASH=$(git ls-files ./data/$version | xargs sha256sum | cut -d" " -f1 | sha256sum | cut -d" " -f1)
            echo "hash for $version: $HASH"

            # check if hash exists in API
            RESPONSE=$(curl -s -w "%{http_code}" "$API_BASE_URL/$version")
            HTTP_CODE=${RESPONSE: -3}
            API_HASH=$(echo "${RESPONSE%???}" | jq -r ".hash" 2>/dev/null || echo "")

            if [ "$HTTP_CODE" = "200" ] && [ "$HASH" = "$API_HASH" ]; then
              echo "hash unchanged for $version - skipping"
              continue
            fi

            echo "hash needs updating for $version"

            # upload new hash to API
            UPLOAD_RESULT=$(curl -s -X POST "$API_BASE_URL/$version" \
              -H "Authorization: $API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"hash\": \"$HASH\"}" \
              -w "%{http_code}")

            if [ "${UPLOAD_RESULT: -3}" = "200" ] || [ "${UPLOAD_RESULT: -3}" = "201" ]; then
              echo "✅ successfully updated hash for $version"
            else
              echo "❌ failed to update hash for $version (HTTP ${UPLOAD_RESULT: -3})"
              echo "api response: ${UPLOAD_RESULT%???}"
              exit 1
            fi
          done

          echo "all hash processing completed successfully"
